<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="rail.bike.demo.db.ItemMapper">

    <select id="selectItem" resultType="hashMap">
        select item_code
              ,fn_code_name(item_code, 'item') item_name
              ,unit_code
              ,fn_code_name(unit_code, 'unit') unit_name
              ,price
              ,`order`
          from tb_item_mstr
         order by `order`, item_code
    </select>

    <select id="insertItem" parameterType="hashMap" resultType="int">
        select fn_put_item(#{item_code}, #{item_name}, #{unit_name}, #{price}, #{order})
    </select>

    <select id="deleteItem" parameterType="hashMap" resultType="int">
        select fn_delete_item(#{item_code})
    </select>

    <select id="selectOrderList" resultType="hashMap">
        select order_info.*
             , item_price + labor total_price
             , row_number() over() order_seq
          from (
                select order_uniq
                     , order_date
                     , bike_number
                     , item_code
                     , fn_code_name(item_code, 'item') item_name
                     , count
                     , (select price from tb_item_mstr tim where tim.item_code = tom.item_code) * count item_price
                     , labor
                  from tb_order_mstr tom
               ) order_info
    </select>

    <select id="selectUnitList" resultType="hashMap">
        select *
          from vw_unit_info
    </select>

    <select id="putOrderInfo" parameterType="hashMap" resultType="int">
        select fn_put_order(#{bike_number}, #{order_date}, #{item_code}, #{labor}, #{count})
    </select>

    <select id="editOrderInfo" parameterType="hashMap" resultType="int">
        select fn_edit_order(#{order_uniq}, #{bike_number}, #{order_date}, #{item_code}, #{labor}, #{count})
    </select>

    <select id="deleteOrderInfo" parameterType="int" resultType="int">
        select fn_delete_order(#{order_uniq})
    </select>

    <select id="selectBillInfo" resultType="hashMap">
        select a.item_code
             , fn_code_name(a.item_code, 'item')
             , fn_code_name(a.unit_code, 'unit')
             , round(((price * sum(count)) + sum(labor)) / 1.1) supply_price
             , round(((price * sum(count)) + sum(labor)) / 11) tax_ammount
             , (price * sum(count)) + sum(labor) total_price
          from (
                select item_code
                     , price
                     , unit_code
                   from tb_item_mstr
               ) a
             , tb_order_mstr as b
         where a.item_code = b.item_code
         group by item_code;
    </select>

</mapper>