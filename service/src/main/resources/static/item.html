<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="utf-8">
    <link href="./css/biz/Item.css" rel="stylesheet">
    <script src="./js/ajax/Ajax.js"></script>
    <script src="./js/biz/Item.js"></script>
    <script>
        let myRowTag;
        const requestHeader = 'application/x-www-form-urlencoded';
        const url = '/item';
        const inputSelector = 'input[type="text"],input[type="number"]';
        const itemCodeSelector = 'input[role="item_code"]';
        const itemRowSelector = '.item-rows';
        const tBodySelector = '.item-table>tbody';
        const unitNameSelector = 'input[role="unit_name"]';
        
        const saveItemInfo = (button) => {
            let queryStr = "";

            Array.from(button.closest('tr').querySelectorAll(inputSelector))
                .forEach(tag => queryStr += `${tag.getAttribute('role')}=${encodeURIComponent(tag.value)}&`);

            makeRequest(getItemInfo, 'PUT', url, requestHeader, queryStr.substring(0, queryStr.length - 1));
        }

        const search = (itemList) => {
            const itemRows = Array.from(document.querySelectorAll(itemRowSelector)).slice(1);
            const tableBody = document.querySelector(tBodySelector);

            removeItemList(itemRows);

            for (let index = 0; index < itemList.length; index++) {
                const prefix = `.item-rows:nth-child(${index+3})>td>`;
                const cloneRecord = myRowTag.cloneNode(true);
                
                addItemRow(tableBody, cloneRecord);

                const { textFieldSelector, numberFieldSelector } = getFieldsSelector(prefix);
                const columns = Array.from(document.querySelectorAll(`${textFieldSelector}, ${numberFieldSelector}`));
                const itemMap = itemList[index];

                columns.forEach(column => searchItemList(column, itemMap));
            }
            const itemCodes = document.querySelectorAll(`${itemCodeSelector}`);

            Array.from(itemCodes).slice(1).forEach(changeAttributeReadOnly);
        }

        window.onload = () => {
            myRowTag = document.querySelector(itemRowSelector);

            getItemInfo();
            getUnitInfo('/unit');
        }
    </script>
    <title>품목등록</title>
</head>

<body>
    <table class="item-table" border="1">
        <tr>
            <th>품목코드</th>
            <th>품목명</th>
            <th>단위</th>
            <th>가격</th>
            <th>순번</th>
            <th colspan="2">FUNCTION</th>
        </tr>
        <tr class="item-rows">
            <td><input class="item-code" type="text" role="item_code"></td>
            <td><input type="text" role="item_name"></td>
            <td><input type="text" role="unit_name" list="unit_list"></td>
            <td><input type="number" min="0" value="0" role="price"></td>
            <td><input type="number" min="0" value="0" role="order"></td>
            <td><input class="function-button" type="button" onclick="saveItemInfo(this)" value="저장"></td>
            <td><input class="function-button" type="button" onclick="deleteItemInfo(this)" value="삭제"></td>
        </tr>
    </table>
    <datalist id="unit_list">
        <option value=""></option>
    </datalist>
</body>

</html>