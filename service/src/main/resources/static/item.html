<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="utf-8">
    <link href="./css/biz/Item.css" rel="stylesheet">
    <script src="./js/ajax/Ajax.js"></script>
    <script src="./js/biz/Item.js"></script>
    <script>
        let myRowTag;
        const requestHeader = 'application/x-www-form-urlencoded';
        const url = '/item';
        const inputSelector = 'input[type="text"],input[type="number"]';
        const itemCodeSelector = 'input[role="item_code"]';
        const itemRowSelector = '.item-rows';
        const tBodySelector = '.item-table>tbody';
        const unitNameSelector = 'input[role="unit_name"]';

        const addComboBoxEvent = unitName => unitName.addEventListener('dblclick', comboDblClick);

        const appendDataListOption = (unitMap, dataList, option) => {
            option.value = unitMap.code;
            option.label = unitMap.name;

            dataList.appendChild(option);
        }

        const comboDblClick = dblClickEvent => dblClickEvent.target.blur();

        const getItemInfo = responseResult => (responseResult.responseText > 0) ? makeRequest(search, 'GET', url) : false;

        const deleteItemInfo = button => makeRequest(getItemInfo, 'DELETE', url, requestHeader, deleteQueryStr(button
            .closest('tr').querySelector(itemCodeSelector)));

        const deleteQueryStr = itemCode => `item_code=${itemCode.value}`;

        const getUnitInfo = (userUrl, userMethod) => makeFetch(userUrl, userMethod, (unitList)=>{
            const dataList = document.querySelector('datalist');
            const option = document.querySelector('datalist>option').cloneNode(true);

            unitList.forEach(unitMap => appendDataListOption(unitMap, dataList, option));
        });

        const saveItemInfo = (button) => {
            let queryStr = "";

            Array.from(button.closest('tr').querySelectorAll(inputSelector))
                .forEach(tag => queryStr += `${tag.getAttribute('role')}=${encodeURIComponent(tag.value)}&`);

            makeRequest(getItemInfo, 'PUT', url, requestHeader, queryStr.substring(0, queryStr.length - 1));
        }

        const search = (responseResult) => {
            const itemList = JSON.parse(responseResult.responseText) ?? [];
            const itemRows = Array.from(document.querySelectorAll(itemRowSelector)).slice(1);
            const tableBody = document.querySelector(tBodySelector);

            itemRows.forEach(row => removeDuplicatedRecord(row.parentElement, row));

            for (let index = 0; index < itemList.length; index++) {
                addItemRow(tableBody, myRowTag.cloneNode(true));

                const columns = Array.from(document.querySelectorAll(
                    `.item-rows:nth-child(${index+3})>td>input[type="text"], .item-rows:nth-child(${index+3})>td>input[type="number"]`
                    ));

                addComboBoxEvent(document.querySelector(`.item-rows:nth-child(${index+3})>td>${unitNameSelector}`))

                columns.forEach(column => searchItemList(column, itemList[index], column.getAttribute('role')));
            }

            const itemCodes = Array.from(document.querySelectorAll('.item-rows>td>input[role="item_code"]')).slice(
                1);
            itemCodes.forEach(itemCode => changeAttributeReadOnly(itemCode));
        }

        window.onload = () => {
            myRowTag = document.querySelector(itemRowSelector);

            makeRequest(search, 'GET', url);

            getUnitInfo('/unit', 'GET');

            addComboBoxEvent(document.querySelector(unitNameSelector));
        }
    </script>
    <title>품목등록</title>
</head>

<body>
    <table class="item-table" border="1">
        <tr>
            <th>품목코드</th>
            <th>품목명</th>
            <th>단위</th>
            <th>가격</th>
            <th>순번</th>
            <th colspan="2">FUNCTION</th>
        </tr>
        <tr class="item-rows">
            <td><input class="item-code" type="text" role="item_code"></td>
            <td><input type="text" role="item_name"></td>
            <td><input type="text" role="unit_name" list="unit_list"></td>
            <td><input type="number" min="0" value="0" role="price"></td>
            <td><input type="number" min="0" value="0" role="order"></td>
            <td><input class="function-button" type="button" onclick="saveItemInfo(this)" value="저장"></td>
            <td><input class="function-button" type="button" onclick="deleteItemInfo(this)" value="삭제"></td>
        </tr>
    </table>
    <datalist id="unit_list">
        <option value=""></option>
    </datalist>
</body>

</html>