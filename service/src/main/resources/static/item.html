<!DOCTYPE html>
<html lang="ko">
    <head>
        <meta charset="utf-8">
        <script src="./js/ajax/Ajax.js"></script>
        <script>
            let myRowTag;

            const alertContents = (responseResult) => {
                const resultList = JSON.parse(responseResult.responseText);
                
                removeDuplicatedRecord();
                resultList.forEach((resultMap)=>{
                    addItemRow();
                    
                    const rowTags = document.querySelectorAll('#item_rows');
                    const rowTag = rowTags[rowTags.length-1];

                    const item_code = rowTag.querySelector('#item_code');
                    const item_name = rowTag.querySelector('#item_name');
                    const unit_name = rowTag.querySelector('#unit_name');
                    const price = rowTag.querySelector('#price');
                    const order = rowTag.querySelector('#order');

                    item_code.value = resultMap.item_code;
                    item_name.value = resultMap.item_name;
                    unit_name.value = resultMap.unit_name;
                    price.value = resultMap.price;
                    order.value = resultMap.order;
                });
            }

            const addItemRow = () => {
                const myTable = document.querySelector('#item_table');
                const cloneRowNode = myRowTag.cloneNode(true);
                cloneRowNode.querySelector('#item_code').value = '';
                cloneRowNode.querySelector('#item_name').value = '';
                cloneRowNode.querySelector('#unit_name').value = '';
                cloneRowNode.querySelector('#price').value = '';
                cloneRowNode.querySelector('#order').value = '';
                myTable.tBodies[0].appendChild(cloneRowNode);
            }

            const saveItemInfo = (button) => {
                const saveRow = button.closest('tr');

                const item_code = saveRow.querySelector('#item_code').value;
                const item_name = saveRow.querySelector('#item_name').value;
                const unit_name = saveRow.querySelector('#unit_name').value;
                const price = saveRow.querySelector('#price').value;
                const order = saveRow.querySelector('#order').value;

                const queryStr = `item_code=${item_code}&item_name=${encodeURIComponent(item_name)}&unit_name=${encodeURIComponent(unit_name)}&price=${price}&order=${order}`;

                makeRequest(saveContents, 'PUT', '/item', 'application/x-www-form-urlencoded', queryStr);
            }

            const saveContents = (responseResult) => {
                if(responseResult.responseText > 0){
                    makeRequest(alertContents, 'GET', '/item');
                }
            }

            const deleteItemInfo = (button) => {
                const saveRow = button.closest('tr');

                httpRequest = new XMLHttpRequest();
                const item_code = saveRow.querySelector('#item_code').value;

                const queryStr = `item_code=${item_code}`;

                if(!httpRequest){
                    console.error(`Can't make XMLHTTP instance.`);
                    return false;
                }

                httpRequest.onreadystatechange = saveContents;
                httpRequest.open('DELETE', '/item');
                httpRequest.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
                httpRequest.send(queryStr);
            }

            const removeDuplicatedRecord = () => {
                const item_rows = document.querySelectorAll('#item_rows');

                for(let index=1; index < item_rows.length; index++)
                    item_rows[index].parentElement.removeChild(item_rows[index]);
            }

            window.onload = () => {
                myRowTag = document.querySelector('#item_rows');

                makeRequest(alertContents, 'GET', '/item');
            }
        </script>
        <title>품목등록</title>
    </head>
    <body>
        <table id="item_table" border="1">
            <tr>
                <th>
                    품목코드
                </th>
                <th>
                    품목명
                </th>
                <th>
                    단위
                </th>
                <th>
                    가격
                </th>
                <th>
                    순번
                </th>
            </tr>
            <tr id="item_rows">
                <td>
                    <input id="item_code" type="text" >
                </td>
                <td>
                    <input id="item_name" type="text" >
                </td>
                <td>
                    <input id="unit_name" type="text" >
                </td>
                <td>
                    <input id="price" type="number" min="0" value="0">
                </td>
                <td>
                    <input id="order" type="number" min="0" value="0">
                </td>
                <td>
                    <input type="button" onclick="saveItemInfo(this)" value="저장">
                </td>
                <td>
                    <input type="button" onclick="deleteItemInfo(this)" value="삭제">
                </td>
            </tr>
        </table>
    </body>
</html>