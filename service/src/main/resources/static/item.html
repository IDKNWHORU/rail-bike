<!DOCTYPE html>
<html lang="ko">
    <head>
        <meta charset="utf-8">
        <link href="./css/biz/Item.css" rel="stylesheet">
        <script src="./js/ajax/Ajax.js"></script>
        <script src="./js/biz/Item.js"></script>
        <script>
            let myRowTag;

            const deleteItemInfo = (button) => {
                const saveRow = button.closest('tr');
                const item_code = saveRow.querySelector('#item_code').value;
                const queryStr = `item_code=${item_code}`;

                makeRequest(saveContents, 'DELETE', '/item', 'application/x-www-form-urlencoded', queryStr);
            }

            const saveContents = (responseResult) => {
                if(responseResult.responseText > 0){
                    makeRequest(search, 'GET', '/item');
                }
            }

            const saveItemInfo = (button) => {
                const saveRow = button.closest('tr');

                const item_code = saveRow.querySelector('#item_code').value;
                const item_name = saveRow.querySelector('#item_name').value;
                const unit_name = saveRow.querySelector('#unit_name').value;
                const price = saveRow.querySelector('#price').value;
                const order = saveRow.querySelector('#order').value;

                const queryStr = `item_code=${item_code}&item_name=${encodeURIComponent(item_name)}&unit_name=${encodeURIComponent(unit_name)}&price=${price}&order=${order}`;

                makeRequest(saveContents, 'PUT', '/item', 'application/x-www-form-urlencoded', queryStr);
            }

            const search = (responseResult) => {
                const itemCodes = Array.from(document.querySelectorAll('#item_code')).slice(1);
                const itemList = JSON.parse(responseResult.responseText)??[];
                const itemRows = Array.from(document.querySelectorAll('#item_rows')).slice(1);
                const tableBody = document.querySelector('#item_table>tbody');

                itemRows.forEach(row => removeDuplicatedRecord(row.parentElement, row));

                for(let index=0; index < itemList.length; index++){
                    addItemRow(tableBody, myRowTag.cloneNode(true));

                    const columns = Array.from(document.querySelectorAll(`#item_rows:nth-child(${index+3})>td>input[type="text"], #item_rows:nth-child(${index+3})>td>input[type="number"]`));

                    columns.forEach(column => searchItemList(column, itemList[index], column.getAttribute('role')));
                }

                itemCodes.forEach(itemCode => changeAttributeReadOnly(itemCode));
            }

            window.onload = () => {
                myRowTag = document.querySelector('#item_rows');

                makeRequest(search, 'GET', '/item');
            }
        </script>
        <title>품목등록</title>
    </head>
    <body>
        <table id="item_table" border="1">
            <tr>
                <th>품목코드</th>
                <th>품목명</th>
                <th>단위</th>
                <th>가격</th>
                <th>순번</th>
                <th colspan="2">FUNCTION</th>
            </tr>
            <tr id="item_rows">
                <td>
                    <input id="item_code" class="item-code" type="text" role="item_code">
                </td>
                <td>
                    <input id="item_name" type="text" role="item_name">
                </td>
                <td>
                    <input id="unit_name" type="text" role="unit_name">
                </td>
                <td>
                    <input id="price" type="number" min="0" value="0" role="price">
                </td>
                <td>
                    <input id="order" type="number" min="0" value="0" role="order">
                </td>
                <td>
                    <input id="save" class="save-button" type="button" onclick="saveItemInfo(this)" value="저장">
                </td>
                <td>
                    <input id="delete" class="save-button" type="button" onclick="deleteItemInfo(this)" value="삭제">
                </td>
            </tr>
        </table>
    </body>
</html>