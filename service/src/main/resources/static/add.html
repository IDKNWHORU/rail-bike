<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <link href="./css/biz/add.css" rel="stylesheet">
    <script src="./js/ajax/Ajax.js"></script>
    <script src="./js/biz/Add.js"></script>
    <script>
        const url = "/order";

        const optionCloning = (node, map) => {
            const clone = node.cloneNode();

            clone.value = map.item_code;
            clone.innerHTML = map.item_name;
            clone.dataset.value = map.item_code;
            clone.dataset.label = map.item_name;
            clone.dataset.price = map.price;

            return clone;
        }

        const getListInfo = () => {
            makeFetch(url, {
                method: 'GET'
            }, putOrderList);

            makeFetch('/item', {
                method: 'GET'
            }, (list) => {
                const optionNode = document.querySelector('datalist>option');

                list.forEach((map)=>{
                    const optionClone = optionCloning(optionNode, map);

                    optionNode.parentNode.appendChild(optionClone);
                })
            })
        };

        window.onload = () => {
            getListInfo();
        };

        const saveOrderInfo = (button) => {
            const inputFieldsNode = document.querySelector('.input-area').children;
            const inputFields = Array.from(inputFieldsNode);
            const orderObject = {};
            let isValid = true;

            inputFields.some((fieldWrapper) => {
                const inputField = fieldWrapper.firstChild;

                if(validField(inputField)){
                    inputOrderInfo(inputField, orderObject);
                }else{
                    isValid = false;
                    
                    return true;
                }
            });

            (isValid) ? makeFetch(url, {method: 'PUT', headers: {"Content-Type": "application/json"}, body:JSON.stringify(orderObject)}, returnedMethod) : returnedMethod({result: false, msg : '필수값을 입력하세요'});
        }

        const returnedMethod = (resultMap) => {
            putMessage(resultMap.msg);

            if(resultMap.result){
                orderListRefresh();
            }
        }

        const inputOrderInfo = (field, orderObject) => {
            const objectKey = field.dataset.role;

            orderObject[objectKey] = field.value;
        };

        const putMessage = message => {
            const modal = document.querySelector('.modal')
            
            modal.innerHTML = message;
            visibleModal(modal, true);

            setTimeout(visibleModal, 1500, modal, false)
        }

        const validField = field => {
            const result = true;
            if(field.required){
                if(field.value === ''){
                    return false;
                }
            }
            
            return result;
        }

        const visibleModal = (modal, visible) => {
            if(visible){
                modal.classList.add('visible');
            }else{
                modal.classList.remove('visible');
            }
        }

        const orderListRefresh = () =>{
            const orderRecord = document.querySelectorAll('.order-row');
            const orderTableBody = document.querySelector('tbody');

            for(let index = 1; index < orderRecord.length; index++){
                orderTableBody.removeChild(orderRecord[index]);
            }

            getListInfo();
        }
    </script>
    <title>전표등록</title>
</head>

<body>
    <div class="menu-title">전표등록</div>
    <div>
        <div class="left-area input-box-area">
            <div class="left-area label-area">
                <div class="label-field">입력일자<span class="required">*</span></div>
                <div class="label-field">거래처</div>
                <div class="label-field">차대번호<span class="required">*</span></div>
                <div class="label-field">품목<span class="required">*</span></div>
                <div class="label-field">수량<span class="required">*</span></div>
                <div class="label-field">금액<span class="required">*</span></div>
                <div class="label-field">추가공임</div>
                <div class="label-field">합계</div>
            </div>
            <div class="right-area input-area">
                <div><input type="date" required pattern="\d{4}-\d{2}-\d{2}" data-role="order_date"></div>
                <div><input type="text" required data-role="customer"></div>
                <div><input type="number" required min="0" data-role="bike_number"></div>
                <div><input type="text" required data-role="item_code" list="item_list"></div>
                <div><input type="number" min="0" required data-role="count"></div>
                <div><input type="number" min="0" value="0" required data-role="item_price"></div>
                <div><input type="number" min="0" value="0" data-role="labor"></div>
                <div><input class="total-field" type="number" min="0" readonly="true" value="0" data-role="total_price"></div>
                <datalist id="item_list"><option value=""></option></datalist>
            </div>
            <div><input class="save-button" type="button" value="입력하기" onclick="saveOrderInfo(this)"></div>
        </div>
        <div class="right-area list-area">
            <table>
                <caption class="item-caption">전표 리스트</caption>
                <tr>
                    <th scope="col">순번</th>
                    <th scope="col">주문일자</th>
                    <th scope="col">차대번호</th>
                    <th scope="col">품목</th>
                    <th scope="col">수량</th>
                    <th scope="col">금액</th>
                    <th scope="col">추가공임</th>
                    <th scope="col">합계</th>
                </tr>
                <tr class="order-row">
                    <td class="order-field number-field" data-role="order_seq"></td>
                    <td class="date-field" data-role="order_date"></td>
                    <td class="car-field number-field" data-role="bike_number"></td>
                    <td class="item-field hyper-field" data-role="item_name"></td>
                    <td class="quantity-field number-field" data-role="count"></td>
                    <td class="price-field number-field" data-role="item_price"></td>
                    <td class="overpay-field number-field" data-role="labor"></td>
                    <td class="sum-field" data-role="total_price"></td>
                </tr>
            </table>
        </div>
    </div>
    <div class="modal"></div>
</body>

</html>